= Usage Examples
:toc: left
:toc-title: Table of Contents
:toclevels: 3
:sectnums:
:source-highlighter: highlight.js

== Overview

This document provides 24 complete, runnable examples covering all common use cases including error handling, retry logic, and security integration.

== Basic Setup

All examples assume this basic setup:

[source,java]
----
// HTTP Handler configuration
HttpHandler handler = HttpHandler.builder()
    .uri("https://api.example.com/users")
    .connectionTimeoutSeconds(5)
    .readTimeoutSeconds(10)
    .sslContextProvider(SecureSSLContextProvider.builder().build())
    .build();

// Converter for User objects (implements both request and response)
class UserConverter extends StringContentConverter<User>
        implements HttpResponseConverter<User>, HttpRequestConverter<User> {
    @Override
    protected Optional<User> convertString(String rawContent) {
        return Optional.ofNullable(parseJsonToUser(rawContent));
    }

    @Override
    public HttpRequest.BodyPublisher toBodyPublisher(@Nullable User user) {
        if (user == null) return HttpRequest.BodyPublishers.noBody();
        String json = convertUserToJson(user);
        return HttpRequest.BodyPublishers.ofString(json, StandardCharsets.UTF_8);
    }

    @Override
    public ContentType contentType() {
        return ContentType.APPLICATION_JSON;
    }
}

UserConverter userConverter = new UserConverter();
----

== Example 1: Simple GET Request (Async)

[source,java]
----
// Create adapter (ETag caching enabled by default)
HttpAdapter<User> adapter = ETagAwareHttpAdapter.<User>builder()
    .httpHandler(handler)
    .responseConverter(userConverter)
    .requestConverter(userConverter)
    .build();

// Send GET request (async) - returns CompletableFuture
CompletableFuture<HttpResult<User>> futureResult = adapter.get();

// Handle result asynchronously (recommended)
futureResult.thenAccept(result -> {
    if (result.isSuccess()) {
        result.getContent().ifPresent(user ->
            LOGGER.info("Loaded user: {}", user.getName()));

        // Check if served from cache
        if (result.getHttpStatus().orElse(0) == 304) {
            LOGGER.debug("Content served from ETag cache");
        }
    } else {
        result.getErrorMessage().ifPresent(LOGGER::error);
    }
});

// Or use blocking method for simple cases
HttpResult<User> result = adapter.getBlocking();
if (result.isSuccess()) {
    LOGGER.info("User: {}", result.getContent().map(User::getName).orElse("N/A"));
}
----

== Example 2: GET with Pattern Matching (Blocking)

[source,java]
----
HttpAdapter<User> adapter = ETagAwareHttpAdapter.<User>builder()
    .httpHandler(handler)
    .responseConverter(userConverter)
    .requestConverter(userConverter)
    .build();

// Use blocking method for pattern matching
HttpResult<User> result = adapter.getBlocking();

// Pattern matching (Java 17+)
switch (result) {
    case HttpResult.Success<User>(var user, var etag, var status) -> {
        LOGGER.info("Success: {}", user.getName());
        if (status == 304) {
            LOGGER.debug("Cached with ETag: {}", etag);
        }
    }
    case HttpResult.Failure<User> failure -> {
        LOGGER.error("Failed: {}", failure.errorMessage());
        if (failure.isRetryable()) {
            LOGGER.warn("Consider retry");
        }
    }
}
----

== Example 3: POST Request Creating Resource

[source,java]
----
// Create adapter
HttpAdapter<User> adapter = ETagAwareHttpAdapter.<User>builder()
    .httpHandler(handler)
    .responseConverter(userConverter)
    .requestConverter(userConverter)
    .build();

// Prepare User object
User newUser = User.builder()
    .name("John Doe")
    .email("john@example.com")
    .role("USER")
    .build();

// Send POST request (request converter handles serialization)
HttpResult<User> result = adapter.post(newUser);

// Handle result
if (result.isSuccess()) {
    result.getContent().ifPresent(createdUser -> {
        LOGGER.info("Created user with ID: {}", createdUser.getId());
        result.getETag().ifPresent(etag ->
            LOGGER.debug("Created with ETag: {}", etag));
    });
} else {
    LOGGER.error("Creation failed: {}",
        result.getErrorMessage().orElse("Unknown error"));
}
----

== Example 4: PUT Request Updating Resource

[source,java]
----
HttpHandler updateHandler = HttpHandler.builder()
    .uri("https://api.example.com/users/123")  // Specific user
    .build();

HttpAdapter<User> adapter = ETagAwareHttpAdapter.<User>builder()
    .httpHandler(updateHandler)
    .responseConverter(userConverter)
    .requestConverter(userConverter)
    .build();

User updatedUser = User.builder()
    .name("Jane Doe")
    .email("jane@example.com")
    .role("ADMIN")
    .build();

HttpResult<User> result = adapter.put(updatedUser);

switch (result) {
    case HttpResult.Success<User>(var user, var etag, var status) -> {
        LOGGER.info("Updated user successfully");
        etag.ifPresent(tag -> LOGGER.debug("New ETag: {}", tag));
    }
    case HttpResult.Failure<User> failure -> {
        LOGGER.error("Update failed: {}", failure.errorMessage());
        failure.getErrorCategory().ifPresent(category -> {
            if (category == HttpErrorCategory.CLIENT_ERROR) {
                LOGGER.error("Check request data - likely validation error");
            }
        });
    }
}
----

== Example 5: DELETE Request

[source,java]
----
HttpHandler deleteHandler = HttpHandler.builder()
    .uri("https://api.example.com/users/123")
    .build();

// Use built-in void converter (ignores response body)
HttpAdapter<Void> adapter = ETagAwareHttpAdapter.<Void>builder()
    .httpHandler(deleteHandler)
    .responseConverter(VoidResponseConverter.INSTANCE)
    .build();

// Send DELETE request (no body)
HttpResult<Void> result = adapter.delete();

if (result.isSuccess()) {
    LOGGER.info("User deleted successfully");
} else {
    LOGGER.error("Delete failed: {}",
        result.getErrorMessage().orElse("Unknown error"));
}
----

== Example 6: Authenticated Request

[source,java]
----
HttpAdapter<User> adapter = ETagAwareHttpAdapter.<User>builder()
    .httpHandler(handler)
    .responseConverter(userConverter)
    .requestConverter(userConverter)
    .build();  // Default: CacheKeyHeaderFilter.ALL

// ⚠️ EFFICIENCY NOTE: Authorization headers are included in cache key by default.
//
// Multi-user scenario (web server):
//   ✅ GOOD: Each user gets separate cache entries
//   ✅ Efficient: Avoids wasted If-None-Match requests (user ETags won't match)
//
// Single-user scenario (mobile app, desktop):
//   ❌ Cache bloat: Token refresh creates duplicate entries
//   ✅ Solution: Use CacheKeyHeaderFilter.NONE or excluding("Authorization") (see Example 6b)

// Add Authorization header
Map<String, String> headers = Map.of(
    "Authorization", "Bearer " + getAccessToken()
);

HttpResult<User> result = adapter.get(headers);
----

== Example 6b: Authenticated Request (Single-User Client)

[source,java]
----
// Mobile app, desktop app, or service account
HttpAdapter<User> adapter = ETagAwareHttpAdapter.<User>builder()
    .httpHandler(handler)
    .responseConverter(userConverter)
    .requestConverter(userConverter)
    .cacheKeyHeaderFilter(CacheKeyHeaderFilter.NONE)  // URI only, ignore all headers
    .build();

// Token refresh doesn't create duplicate cache entries
Map<String, String> headers = Map.of(
    "Authorization", "Bearer " + getAccessToken()
);

HttpResult<User> result = adapter.get(headers);
// Cache key: URI only (e.g., "https://api.example.com/users")
// Token changes don't affect caching
----

== Example 7: Disable ETag Caching

[source,java]
----
// Explicitly disable ETag caching
HttpAdapter<User> adapter = ETagAwareHttpAdapter.<User>builder()
    .httpHandler(handler)
    .responseConverter(userConverter)
    .requestConverter(userConverter)
    .etagCachingEnabled(false)  // Disable
    .build();

HttpResult<User> result = adapter.get();
// No If-None-Match header added, no 304 handling
----

== Example 8: With Retry (Default Configuration)

[source,java]
----
// Base adapter
HttpAdapter<User> baseAdapter = ETagAwareHttpAdapter.<User>builder()
    .httpHandler(handler)
    .responseConverter(userConverter)
    .requestConverter(userConverter)
    .build();

// Wrap with retry (default: 5 attempts, exponential backoff)
HttpAdapter<User> resilientAdapter = ResilientHttpAdapter.wrap(baseAdapter);

// Async execution - returns CompletableFuture
CompletableFuture<HttpResult<User>> futureResult = resilientAdapter.get();

// Handle result asynchronously
futureResult.thenAccept(result -> {
    if (result.isSuccess()) {
        LOGGER.info("User loaded: {}", result.getContent());
    }
});

// Or block if needed (not recommended in async contexts)
HttpResult<User> result = futureResult.join();
// Automatically retries on NETWORK_ERROR and SERVER_ERROR
----

== Example 9: With Custom Retry Configuration

[source,java]
----
// Custom retry configuration
RetryConfig customRetry = RetryConfig.builder()
    .maxAttempts(3)                    // Only 3 attempts
    .initialDelay(Duration.ofMillis(500))  // Start with 500ms
    .multiplier(1.5)                   // Slower backoff
    .maxDelay(Duration.ofSeconds(30))  // Cap at 30s
    .jitter(0.2)                       // 20% jitter
    .build();

// Base adapter
HttpAdapter<User> baseAdapter = ETagAwareHttpAdapter.<User>builder()
    .httpHandler(handler)
    .responseConverter(userConverter)
    .requestConverter(userConverter)
    .build();

// Wrap with custom retry
HttpAdapter<User> resilientAdapter = ResilientHttpAdapter.wrap(
    baseAdapter,
    customRetry
);

User newUser = User.builder().name("John").build();

// Async execution
CompletableFuture<HttpResult<User>> futureResult = resilientAdapter.post(newUser);

// Chain async operations
futureResult
    .thenApply(result -> result.getValue().orElse(null))
    .thenAccept(createdUser -> LOGGER.info("User created: {}", createdUser))
    .exceptionally(ex -> {
        LOGGER.error("Async operation failed", ex);
        return null;
    });
----

== Example 10: Error Handling by Category

[source,java]
----
HttpAdapter<User> adapter = ETagAwareHttpAdapter.<User>builder()
    .httpHandler(handler)
    .responseConverter(userConverter)
    .requestConverter(userConverter)
    .build();

HttpResult<User> result = adapter.get();

result.getErrorCategory().ifPresent(category -> {
    switch (category) {
        case NETWORK_ERROR -> {
            LOGGER.warn("Network error, schedule retry");
            scheduleRetry();
        }
        case SERVER_ERROR -> {
            LOGGER.warn("Server error (5xx), schedule retry");
            scheduleRetry();
        }
        case CLIENT_ERROR -> {
            LOGGER.error("Client error (4xx), check request");
            alertOperations("Invalid HTTP request");
        }
        case INVALID_CONTENT -> {
            LOGGER.error("Response content invalid");
            useFallbackSource();
        }
        case CONFIGURATION_ERROR -> {
            LOGGER.error("Configuration error, check SSL/URL");
            alertOperations("HTTP handler misconfigured");
        }
    }
});
----

== Example 11: XML Request Body

[source,java]
----
// Create XML converter (implements both interfaces for same type)
class XmlStringConverter extends StringContentConverter<String>
        implements HttpResponseConverter<String>, HttpRequestConverter<String> {
    @Override
    protected Optional<String> convertString(String rawContent) {
        return Optional.of(rawContent);
    }

    @Override
    public HttpRequest.BodyPublisher toBodyPublisher(@Nullable String content) {
        if (content == null) return HttpRequest.BodyPublishers.noBody();
        return HttpRequest.BodyPublishers.ofString(content, StandardCharsets.UTF_8);
    }

    @Override
    public ContentType contentType() {
        return ContentType.APPLICATION_XML;
    }
}

XmlStringConverter xmlConverter = new XmlStringConverter();

String xmlBody = """
    <?xml version="1.0"?>
    <user>
        <name>John Doe</name>
        <email>john@example.com</email>
    </user>
    """;

// String→User: use request converter for different type
HttpResult<User> result = adapter.post(xmlConverter, xmlBody);
----

== Example 12: Plain Text Request

[source,java]
----
// String converter (implements both interfaces for same type)
class TextConverter extends StringContentConverter<String>
        implements HttpResponseConverter<String>, HttpRequestConverter<String> {
    @Override
    protected Optional<String> convertString(String rawContent) {
        return Optional.of(rawContent);
    }

    @Override
    public HttpRequest.BodyPublisher toBodyPublisher(@Nullable String content) {
        if (content == null) return HttpRequest.BodyPublishers.noBody();
        return HttpRequest.BodyPublishers.ofString(content, StandardCharsets.UTF_8);
    }

    @Override
    public ContentType contentType() {
        return ContentType.TEXT_PLAIN;
    }
}

TextConverter textConverter = new TextConverter();

HttpAdapter<String> textAdapter = ETagAwareHttpAdapter.<String>builder()
    .httpHandler(handler)
    .responseConverter(textConverter)
    .requestConverter(textConverter)
    .build();

String textBody = "User registration data...";
HttpResult<String> result = textAdapter.post(textBody);
----

== Example 13: Binary Data (Image Upload)

[source,java]
----
byte[] imageData = Files.readAllBytes(Path.of("profile.png"));

// Binary converter (implements request interface only for upload)
class ImageRequestConverter implements HttpRequestConverter<byte[]> {
    @Override
    public HttpRequest.BodyPublisher toBodyPublisher(@Nullable byte[] content) {
        if (content == null) return HttpRequest.BodyPublishers.noBody();
        return HttpRequest.BodyPublishers.ofByteArray(content);
    }

    @Override
    public ContentType contentType() {
        return ContentType.IMAGE_PNG;
    }
}

ImageRequestConverter imageConverter = new ImageRequestConverter();

HttpAdapter<Response> adapter = ETagAwareHttpAdapter.<Response>builder()
    .httpHandler(uploadHandler)
    .responseConverter(responseConverter)
    .build();

// byte[]→Response: use request converter for different type
HttpResult<Response> result = adapter.post(imageConverter, imageData);
----

== Example 14: Clear ETag Cache

[source,java]
----
ETagAwareHttpAdapter<User> adapter = ETagAwareHttpAdapter.<User>builder()
    .httpHandler(handler)
    .responseConverter(userConverter)
    .requestConverter(userConverter)
    .build();

// Use adapter...
HttpResult<User> result = adapter.get();

// Later, clear cache
adapter.clearETagCache();
----

== Example 15: Fallback Content on Failure

[source,java]
----
HttpAdapter<User> adapter = ResilientHttpAdapter.wrap(
    ETagAwareHttpAdapter.<User>builder()
        .httpHandler(handler)
        .responseConverter(userConverter)
    .requestConverter(userConverter)
        .build()
);

// Async execution with fallback
CompletableFuture<User> userFuture = adapter.get()
    .thenApply(result -> result.getContent().orElseGet(() -> loadUserFromCache()));

// Handle user asynchronously
userFuture.thenAccept(user -> {
    LOGGER.info("User loaded (from API or cache): {}", user.getName());
    processUser(user);
});

// Or block if needed
User user = userFuture.join();
----

== Example 16: Multiple Headers

[source,java]
----
Map<String, String> headers = Map.of(
    "Authorization", "Bearer " + token,
    "X-Request-ID", UUID.randomUUID().toString(),
    "X-Client-Version", "1.0.0"
);

HttpResult<User> result = adapter.get(headers);
----

== Example 17: PATCH Request

[source,java]
----
User patchData = User.builder()
    .email("newemail@example.com")
    .build();

HttpResult<User> result = adapter.patch(patchData);
----

== Example 18: HEAD Request (Metadata Only)

[source,java]
----
// HEAD returns no body, only headers
HttpResult<Void> result = voidAdapter.head();

if (result.isSuccess()) {
    result.getETag().ifPresent(etag ->
        LOGGER.info("Resource ETag: {}", etag));
    result.getHttpStatus().ifPresent(status ->
        LOGGER.info("Resource status: {}", status));
}
----

== Example 19: OPTIONS Request

[source,java]
----
HttpResult<String> result = stringAdapter.options();

if (result.isSuccess()) {
    // Server may return allowed methods in response
    result.getContent().ifPresent(LOGGER::info);
}
----

== Example 20: Handling Network Errors

[source,java]
----
HttpAdapter<User> adapter = ETagAwareHttpAdapter.<User>builder()
    .httpHandler(handler)
    .responseConverter(userConverter)
    .requestConverter(userConverter)
    .build();

try {
    HttpResult<User> result = adapter.get();

    switch (result) {
        case HttpResult.Success<User>(var user, var etag, var status) -> {
            LOGGER.info("Success: {}", user);
        }
        case HttpResult.Failure<User> failure -> {
            // Check if caused by IOException (network error)
            if (failure.cause() instanceof IOException ioEx) {
                LOGGER.error("Network error: {}", ioEx.getMessage());
                // Retry or use fallback source
                scheduleRetry();
            }
        }
    }
} catch (Exception e) {
    LOGGER.error("Unexpected error", e);
}
----

== Example 21: Handling SSL/TLS Errors

[source,java]
----
HttpResult<User> result = adapter.get();

if (!result.isSuccess()) {
    result.getCause().ifPresent(cause -> {
        if (cause instanceof SSLException sslEx) {
            LOGGER.error("SSL/TLS error: {}", sslEx.getMessage());
            // Check certificate configuration
            alertOperations("SSL certificate issue detected");
        } else if (cause instanceof SSLHandshakeException) {
            LOGGER.error("SSL handshake failed - possible certificate mismatch");
        }
    });
}
----

== Example 22: Handling Timeout Scenarios

[source,java]
----
// Configure handler with timeout
HttpHandler handler = HttpHandler.builder()
    .uri("https://api.example.com/users")
    .connectionTimeoutSeconds(5)
    .readTimeoutSeconds(10)
    .build();

HttpAdapter<User> adapter = ETagAwareHttpAdapter.<User>builder()
    .httpHandler(handler)
    .responseConverter(userConverter)
    .requestConverter(userConverter)
    .build();

HttpResult<User> result = adapter.get();

result.getCause().ifPresent(cause -> {
    if (cause instanceof HttpTimeoutException) {
        LOGGER.warn("Request timed out");
        // Use cached data if available
        useStaleCache();
    }
});
----

== Example 23: Handling JSON Parsing Failures

[source,java]
----
// User converter with error handling (implements both interfaces)
class UserConverterWithErrorHandling extends StringContentConverter<User>
        implements HttpResponseConverter<User>, HttpRequestConverter<User> {
    @Override
    protected Optional<User> convertString(String rawContent) {
        try {
            return Optional.ofNullable(parseJsonToUser(rawContent));
        } catch (JsonParseException e) {
            LOGGER.error("JSON parsing failed: {}", e.getMessage());
            return Optional.empty();  // Converter returns empty
        }
    }

    @Override
    public HttpRequest.BodyPublisher toBodyPublisher(@Nullable User user) {
        if (user == null) return HttpRequest.BodyPublishers.noBody();
        String json = convertUserToJson(user);
        return HttpRequest.BodyPublishers.ofString(json, StandardCharsets.UTF_8);
    }

    @Override
    public ContentType contentType() {
        return ContentType.APPLICATION_JSON;
    }
}

UserConverterWithErrorHandling userConverter = new UserConverterWithErrorHandling();

HttpAdapter<User> adapter = ETagAwareHttpAdapter.<User>builder()
    .httpHandler(handler)
    .responseConverter(userConverter)
    .requestConverter(userConverter)
    .build();

HttpResult<User> result = adapter.get();

if (result.isSuccess() && result.getContent().isEmpty()) {
    LOGGER.warn("Response received but content could not be parsed");
    // Check error category
    result.getErrorCategory().ifPresent(category -> {
        if (category == HttpErrorCategory.INVALID_CONTENT) {
            LOGGER.error("Invalid content format received");
        }
    });
}
----

== Example 24: Comprehensive Error Recovery (Async)

[source,java]
----
public CompletableFuture<User> loadUserWithFallback(String userId) {
    HttpAdapter<User> adapter = ResilientHttpAdapter.wrap(
        ETagAwareHttpAdapter.<User>builder()
            .httpHandler(handler)
            .responseConverter(userConverter)
    .requestConverter(userConverter)
            .build()
    );

    return adapter.get()
        .thenApply(result -> switch (result) {
            case HttpResult.Success<User>(var user, var etag, var status) -> {
                LOGGER.info("Loaded user {} (status: {})", userId, status);
                yield user;
            }
            case HttpResult.Failure<User> failure -> {
                LOGGER.error("Failed to load user {}: {}",
                    userId, failure.errorMessage());

                // Try different recovery strategies based on error category
                HttpErrorCategory category = failure.category();
                yield switch (category) {
                    case NETWORK_ERROR, SERVER_ERROR -> {
                        // Transient error - use cache
                        LOGGER.info("Using cached data for user {}", userId);
                        yield loadUserFromCache(userId);
                    }
                    case CLIENT_ERROR -> {
                        // Bad request - use default user
                        LOGGER.warn("Bad request for user {}, using default", userId);
                        yield createDefaultUser(userId);
                    }
                    case INVALID_CONTENT -> {
                        // Response parsing failed - report and use default
                        LOGGER.error("Invalid response format for user {}", userId);
                        reportDataQualityIssue();
                        yield createDefaultUser(userId);
                    }
                    case CONFIGURATION_ERROR -> {
                        // Configuration issue - alert operations
                        LOGGER.error("Configuration error loading user {}", userId);
                        alertOperations("HTTP client misconfigured");
                        throw new IllegalStateException("Cannot load user", failure.cause());
                    }
                };
            }
        });
}

// Usage:
loadUserWithFallback("user123")
    .thenAccept(user -> LOGGER.info("Processing user: {}", user))
    .exceptionally(ex -> {
        LOGGER.error("Failed to load user", ex);
        return null;
    });
----

