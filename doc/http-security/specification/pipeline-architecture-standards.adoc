= HTTP Security Pipeline Architecture Standards
:toc: left
:toclevels: 3
:toc-title: Table of Contents
:sectnums:
:source-highlighter: highlight.js

== Pipeline Selection Decision Matrix

This document establishes the authoritative standards for selecting appropriate validation pipelines in HTTP security attack database testing.

=== URLPathValidationPipeline - Path-Focused Attacks

**Purpose**: Validates URL path components, directory traversal, and host-based attacks.

**Use When**:

* Attack patterns target **path components only** (no protocol prefix)
* Directory traversal attacks (`../../../etc/passwd`)
* Host/domain-based exploits
* CVE exploits targeting specific server path handling
* IPv6 address parsing in path context

**Current Implementations**:

* ✅ `ApacheCVEAttackDatabaseTest` - Apache-specific path exploits
* ✅ `HomographAttackDatabaseTest` - Domain spoofing attacks
* ✅ `IISCVEAttackDatabaseTest` - IIS path handling exploits
* ✅ `IPv6AttackDatabaseTest` - IPv6 path parsing attacks
* ✅ `NginxCVEAttackDatabaseTest` - Nginx path handling exploits
* ✅ `OWASPTop10AttackDatabaseTest` - Path traversal focused

**Attack Pattern Examples**:

[source]
----
"/../../../etc/passwd"
"[::ffff:127.0.0.1]/../../../etc/passwd"
"/admin/..\\..\\windows\\system32"
----


== Architectural Principles

=== 1. Path vs Content Rule

* **Path-only patterns** → `URLPathValidationPipeline`
* **Parameter values** → `URLParameterValidationPipeline`
* **Header content** → `HTTPHeaderValidationPipeline`

=== 2. Content Type Priority

* **Path traversal/CVE exploits** → `URLPathValidationPipeline`
* **Parameter injection** → `URLParameterValidationPipeline`

=== 3. Encoding Layer Separation (HTTP Protocol vs Application Layer)

==== HTTP Protocol Layer Scope

**What BELONGS at HTTP validation layer:**

* URL percent-encoding (`%XX` sequences)
* UTF-8 overlong encoding detection
* Double URL encoding (`%25XX` patterns)
* Unicode normalization for URL paths
* HTTP protocol-specific malformations

==== Application Layer Scope

**What DOES NOT BELONG at HTTP validation layer:**

* ❌ HTML entity decoding (`&lt;`, `&#47;`, `&#x2F;`) - Presentation layer concern
* ❌ JavaScript escape sequences (`\x2F`, `\u002F`, `\057`) - Code execution layer concern
* ❌ Base64 encoding/decoding - Application data layer concern
* ❌ XML/JSON parsing - Application format layer concern

==== Rationale

HTTP security validation should focus exclusively on HTTP protocol violations and URL-specific attacks. Application-layer encoding schemes require proper context (HTML rendering, JavaScript execution, data format parsing) that only exists at higher application layers.

=== 4. Unicode Handling

* **Unicode characters in paths** → `URLPathValidationPipeline` with `allowHighBitCharacters(true)`
* **Unicode in parameters** → `URLParameterValidationPipeline` with `allowHighBitCharacters(true)`

=== 5. Configuration Requirements

==== URLPathValidationPipeline Configuration

[source,java]
----
SecurityConfiguration config = SecurityConfiguration.defaults();
// Standard configuration for most path-based attacks

// For Unicode path content:
SecurityConfiguration unicodeConfig = SecurityConfiguration.builder()
    .allowHighBitCharacters(true)
    .build();
----


== Quality Assurance Standards

=== Test Validation Requirements

. **Pipeline Selection Verification**: Each test class must use the correct pipeline based on attack pattern type
. **Expected Failure Type Accuracy**: Test expectations must align with pipeline detection capabilities
. **Configuration Consistency**: Pipeline configuration must support the attack patterns being tested
. **Documentation Alignment**: Test class documentation must accurately describe pipeline selection rationale

=== Architecture Compliance Checklist

* [ ] Attack patterns analyzed for protocol presence
* [ ] Pipeline selection matches content type (path vs parameter vs header)
* [ ] **Encoding layer separation maintained** (HTTP protocol vs application layer)
* [ ] Unicode handling configured appropriately
* [ ] Expected failure types align with pipeline capabilities
* [ ] Test documentation explains pipeline selection rationale

== Implementation History

**QI-21 Pipeline Architecture Optimization** (Phase 1):

* ✅ Audit of all 8 attack database test classes completed
* ✅ Pipeline selection decision matrix established
* ✅ All pipeline assignments verified as architecturally correct
* ✅ No pipeline mismatches identified after thorough analysis

[NOTE]
====
**Key Finding**: HTTPBodyValidationPipeline has been eliminated from the architecture. All URL validation (including full URLs with protocols) is now handled by URLPathValidationPipeline as they represent HTTP protocol-layer concerns, not application body content.
====

== Future Considerations

. **New Attack Database Integration**: Follow this decision matrix when adding new attack databases
. **Pipeline Enhancement**: Consider specialized pipelines for emerging attack vectors
. **Performance Optimization**: Monitor pipeline performance with large attack databases
. **Security Standards Evolution**: Update standards as HTTP security threats evolve

---
_Document Version: 1.0_  
_Last Updated: QI-21 Pipeline Architecture Optimization_  
_Maintained by: HTTP Security Validation Framework Team_